---
title: "Documentation for our Gibbs sampling process"
description: >
  This vignette provides some details on the Gibbs sampler we use as part of
  computing the LT-FH phenotype.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gibbs-sampling-burn-in}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  #fig.path = "../man/figures/gibbs-", #removing this line should fix figures
  out.width = "100%"
)
library(ggplot2)
library(geneference)
library(cowplot)
```

One very important aspect of using Gibbs sampling is to ensure convergence of the sampler. We chose to do this through visualisation, i.e. plotting the values generated by the Gibbs sampler and seeing how many iterations are needed before the values seem stable.
In this vignette, we showcase some of the plots we used when implementing our Gibbs sampler.
The code used for generating the data in this vignette is slightly different from the sampler implemented in our package. The general idea is the same, but it differs in that we save all values generated. This is less efficient, but enables us to plot the convergence.
In these examples, we deal with a setup of 2 parents and no siblings. In the specification of case-control status, a 1 means control and 2 means case. So a configuration with "222" means that the individual, parent number 1 and parent number 2 are all cases.
For each of the chosen configurations, we draw 1000 samples with different starting values, then we plot how the liabilities develop over time to see when they are no longer dependent on the starting value.

```{r conditional, echo=FALSE}
Condition <- function(S, a, person) {
  # DETTE KAN UDELADES NÅR CONDITION ER I PAKKEN. OMSKRIV SENERE KALD MED geneference:::
  #Denne funktion tager som input kovarians matricen og en kolonne vektor (a) af værdier for de nuværende liabilities og person, som er et tal der indikerer hvilken person vi gerne vil have fordelingen for betinget på alle andre.

  #Funktionen returnerer den betinget middelværdi og varians.

  s11 <- S[person, person]
  s12 <- matrix(S[person, -c(person)], nrow = 1)
  s21 <- matrix(S[-c(person), person], ncol = 1)
  s22 <- S[-c(person), -c(person)]
  s22_inv <- solve(s22)

  cond_mu <- s12 %*% s22_inv %*% a[-person]
  cond_S <- s11 - s12 %*% s22_inv %*% s21

  return(c(cond_mu, cond_S))
}
```

```{r gibbs_sampler, echo=FALSE}
Gibbs <- function(conf, start_value, samples) {
  # This implementation is very similar to the one in HENVISNING, with the
  # only difference being the number of values we save. We save all values
  # to be able to make the traceplots.
  conf_list <- strsplit(conf, "")
  n <- length(conf_list[[1]]) + 1
  liabs <- matrix(start_value, nrow = n, ncol = 1)

  data <- matrix(start_value, nrow = samples, ncol = n)

  S <- covmatrix(n - 4, 0.5)

  crit <- qnorm(0.95)

  for (i in 2:samples) {
    for (j in 1:n) {
      pram <- Condition(S, liabs, j)
      mu <- pram[1]
      var <- pram[2]

      if (j == 1) {
        liabs[j] <- rnorm(1, mu, sqrt(var))
      } else{
        crit_U <- pnorm(crit, mu, sqrt(var))
        if (conf_list[[1]][j - 1] == "2") {
          U <- runif(1, crit_U, 1)
        } else{
          U <- runif(1, 0, crit_U)
        }
        liabs[j] <- qnorm(U, mu, sqrt(var))
      }
    }

    data[i, ] <- t(liabs)
  }
  return(data)
}
```

```{r burn_in, echo=FALSE}
# Test to see if the gibbs sampler converges at the same rate for different
# starting values and different configurations with no siblings
start_values <- c(-3, -2, -1, 0, 1, 2, 3)
confs <- c("111", "112", "121", "211", "122", "212", "221", "222")
samples <- 1000
n <- length(table(confs)) * length(table(start_values))
data_g <- as.data.frame(matrix(NA, nrow = samples, ncol = n))
data_f <- as.data.frame(matrix(NA, nrow = samples, ncol = n))
data_p1 <- as.data.frame(matrix(NA, nrow = samples, ncol = n))
data_p2 <- as.data.frame(matrix(NA, nrow = samples, ncol = n))
i <- 1
for (value in start_values) {
  for (conf in confs) {
    param <- Gibbs(conf, value, samples)
    data_g[, i] <- param[, 1]
    data_f[, i] <- param[, 2]
    data_p1[, i] <- param[, 3]
    data_p2[, i] <- param[, 4]
    i <- i + 1
  }
}
```

```{r plot_function, echo=FALSE}
plotter <- function(p, start, conf, liabilities) {
  t <- length(table(conf))
  v <- ceiling(p / t)
  c <- p %% t
  if (c == 0) {
    c <- length(conf)
  }

  label_text <- paste(paste("Start:", start[v]), paste("Configuration:", conf[c]), sep = ", ")

  ggplot(data = liabilities, mapping = aes_string(1:nrow(liabilities), y = names(liabilities)[p]))+
    geom_point(color = "cornflowerblue", size = 0.3) +
    ylim(-4, 4) +
    labs(x = "Iteration", y = "Liability", title = label_text) +
    theme_light() +
    theme(plot.title = element_text(size = 9), axis.title = element_text(size = 8)) +
    NULL
}
```


```{r plots, echo=FALSE, warning = FALSE}
#Genetic liability burn-in
g1 <- plotter(1, start_values, confs, data_g)
g25 <- plotter(25, start_values, confs, data_g) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
g49 <- plotter(49, start_values, confs, data_g) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
g8 <- plotter(8, start_values, confs, data_g)
g32 <- plotter(32, start_values, confs, data_g) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
g56 <- plotter(56, start_values, confs, data_g) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
genetic_liability <- plot_grid(g1, g25, g49, g8, g32, g56,
                    ncol = 3, nrow = 2)
gen_liab_title <- ggdraw() + draw_label("Genetic Liability", fontface='bold',
                                        color = "cornflowerblue")
plot_grid(gen_liab_title, genetic_liability, ncol=1, rel_heights=c(0.1, 1))


#Full liability burn-in
f1 <- plotter(1, start_values, confs, data_f)
f25 <- plotter(25, start_values, confs, data_f) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
f49 <- plotter(49, start_values, confs, data_f) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
f8 <- plotter(8, start_values, confs, data_f)
f32 <- plotter(32, start_values, confs, data_f) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
f56 <- plotter(56, start_values, confs, data_f) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
full_liability <- plot_grid(f1, f25, f49, f8, f32, f56,
                    ncol = 3, nrow = 2)
full_liab_title <- ggdraw() + draw_label("Full Liability", fontface='bold',
                                         color = "cornflowerblue")
plot_grid(full_liab_title, full_liability, ncol=1, rel_heights=c(0.1, 1))


#Parent 1 full liability burn-in
p1_1 <- plotter(1, start_values, confs, data_p1)
p1_25 <- plotter(25, start_values, confs, data_p1) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p1_49 <- plotter(49, start_values, confs, data_p1) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p1_8 <- plotter(8, start_values, confs, data_p1)
p1_32 <- plotter(32, start_values, confs, data_p1) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p1_56 <- plotter(56, start_values, confs, data_p1) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
parent1_liability <- plot_grid(p1_1, p1_25, p1_49, p1_8, p1_32, p1_56,
                    ncol = 3, nrow = 2)
p1_liab_title <- ggdraw() + draw_label("Parent 1 Full Liability",
                                        fontface='bold',
                                        color = "cornflowerblue")
plot_grid(p1_liab_title, parent1_liability, ncol=1, rel_heights=c(0.1, 1))


#Parent 2 full liability burn-in
p2_1 <- plotter(1, start_values, confs, data_p2)
p2_25 <- plotter(25, start_values, confs, data_p2) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p2_49 <- plotter(49, start_values, confs, data_p2) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p2_8 <- plotter(8, start_values, confs, data_p2)
p2_32 <- plotter(32, start_values, confs, data_p2) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p2_56 <- plotter(56, start_values, confs, data_p2) +
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
parent2_liability <- plot_grid(p2_1, p2_25, p2_49, p2_8, p2_32, p2_56,
                    ncol = 3, nrow = 2)
p2_liab_title <- ggdraw() + draw_label("Parent 2 Full Liability",
                                        fontface='bold',
                                        color = "cornflowerblue")
plot_grid(p2_liab_title, parent2_liability, ncol=1, rel_heights=c(0.1, 1))
```

The plots show that all liabilities are independent of their starting value after just a couple of samples, and that it does not matter which starting value is chosen. Furthermore, the plots show that the liabilities are quickly independent of their starting value both when the configuration is "111", meaning nobody has the phenotype and "222", meaning everybody has the phenotype. Therefore, we can conclude that there is no difference in the burn-in iterations for different starting values and that the burn-in is done after just a couple of iterations. 

To make sure that all liabilities are independent of the starting value for any given configuration, we have set the number of iterations for the burn-in in the implementation in geneference to be 200. This should be enough iterations to ensure any configuration has valid liabilities to sample from.
It should be mentioned that we have made several other plots in the implementation process than the ones showed here.
