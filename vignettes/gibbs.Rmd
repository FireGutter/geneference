---
title: "Documentation for our Gibbs sampling process"
description: >
  This vignette provides some details on the Gibbs sampler we use as part of
  computing the LT-FH phenotype.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gibbs-sampling-burn-in}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  #fig.path = "../man/figures/gibbs-", #removing this line should fix figures
  out.width = "100%"
)
library(ggplot2)
library(tidyverse)
library(ggpubr)
```


```{r}
sdmatrix <- function(sib = 0, hsq){
  #Den her funktion tager som input, hvor mange søskende der er i familien og hvad arveligheden er i form af h^2. Herefter laver den kovarians matricen, hvor første rækkeføglgen egen genetik liability, egen fuld liability, parent1 full liability, parent2 full liability og herefter søskende, hvor der er nogen.
  s <- matrix(c(hsq, hsq, rep(0.5*hsq, sib + 2), hsq, 1, rep(0.5*hsq, sib + 2), 0.5*hsq, 0.5*hsq, 1, 0, rep(0.5*hsq, sib), 0.5*hsq, 0.5*hsq, 0, 1, rep(0.5*hsq, sib)), nrow = 4, ncol = 4 + sib, byrow = T)
  
  if(sib != 0){
    for(i in 1:sib){
      s <- rbind(s, c(rep(0.5*hsq, 3 + i), 1, rep(0.5*hsq, sib - i)))
    }
  }
  
  return(s)
}
Condition <- function(S, a, person){
  #Denne funktion tager som input kovarians matricen og en kolonne vektor (a) af værdier for de nuværende liabilities og person, som er et tal der indikerer hvilken person vi gerne vil have fordelingen for betinget på alle andre.
  
  #Funktionen returnerer den betinget middelværdi og varians.
  
  s11 <- S[person,person]
  s12 <- matrix(S[person, -c(person)], nrow = 1)
  s21 <- matrix(S[-c(person),person], ncol = 1)
  s22 <- S[-c(person),-c(person)]
  s22_inv <- solve(s22)
  
  cond_mu <- s12 %*% s22_inv %*% a[-person]
  cond_S <- s11 - s12 %*% s22_inv %*% s21
  
  return(c(cond_mu, cond_S))
}
```

```{r}
Gibbs <- function(conf, start_value, samples){
  conf_list <- strsplit(conf, "") 
  n <- length(conf_list[[1]])+1 
  liabs <- matrix(start_value, nrow = n, ncol = 1)
  
  data <- matrix(start_value, nrow = samples, ncol = n)
  
  S <- sdmatrix(n-4,0.5) 
  
  crit <- qnorm(0.95)  
  
  for(i in 2:samples){
    for (j in 1:n){
      pram <- Condition(S, liabs, j)
      mu <- pram[1]
      var <- pram[2]
      
      if (j== 1){ 
        liabs[j] <- rnorm(1, mu, sqrt(var)) 
      } else { 
        crit_U <- pnorm(crit, mu, sqrt(var))
        if (conf_list[[1]][j-1] == "2"){
          U <- runif(1,crit_U,1) 
        } else{
          U <- runif(1,0,crit_U)
        }
        liabs[j] <- qnorm(U, mu, sqrt(var))
      }
    }
    
    data[i,] <- t(liabs)
  }
  return(data)
}
```

```{r no siblings burn-in data}
#Test to see if they gibbs sampler converges at the same rate for different starting values and different configurations with no siblings
start_values <- c(-3,-2,-1,0,1,2,3)
confs <- c("111","112","121","211", "122", "212", "221", "222")
samples <- 1000
n <- length(table(confs))*length(table(start_values))
data_g <- as.data.frame(matrix(NA,nrow = samples,ncol = n))
data_f <- as.data.frame(matrix(NA,nrow = samples,ncol = n))
data_p1 <- as.data.frame(matrix(NA,nrow = samples,ncol = n))
data_p2 <- as.data.frame(matrix(NA,nrow = samples,ncol = n))
i <- 1
for(value in start_values){
  for(conf in confs){
    param <- Gibbs(conf, value, samples)
    data_g[,i] <- param[,1]
    data_f[,i] <- param[,2]
    data_p1[,i] <- param[,3]
    data_p2[,i] <- param[,4]
    i <- i+1
  }
}
plotter <- function(p, start, conf, liabilities){
  t <- length(table(conf))
  v <- ceiling(p/t)
  c <- p%%t
  if (c==0){
    c <- length(conf)
  }
  
  label_text <- paste(paste("Start =", start[v]), paste("Conf =", conf[c]))
  
  ggplot(data = liabilities, mapping = aes_string(1:nrow(liabilities), y = names(liabilities)[p]))+
    geom_point(color = "black")+
    ylim(-4,4)+
    labs(x = "Iteration", y = "Liability")+
    theme_light()+
    annotate(geom = "text", label = label_text, x=nrow(liabilities)/2, y = -3.5, fontface =2)
  
  #plot(data[,p], xlab = "Iteration", ylab = "Liability", main = title, ylim = c(-4,4))
  #legend("bottomright",legend = paste(paste("start = ", start[v]), paste("conf = ", conf[c])))
}
```

After creating the data for the Gibbs sampler with 1000 samples for different starting values and families with no siblings, then we can plot how the liabilities develop over time to see when they are no longer dependent on the starting value.

```{r looking at different starting values}
#Genetic liability burn-in
g1 <- plotter(1, start_values, confs, data_g)
g25 <- plotter(25, start_values, confs, data_g)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
g49 <- plotter(49, start_values, confs, data_g)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
g8 <- plotter(8, start_values, confs, data_g)
g32 <- plotter(32, start_values, confs, data_g)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
g56 <- plotter(56, start_values, confs, data_g)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
genetic_liability <- ggarrange(g1, g25, g49, g8, g32, g56,
                    ncol = 3, nrow = 2)
annotate_figure(genetic_liability,
                top = text_grob("Genetic Liability", face = "bold", size = 14))
#Full liability burn-in
f1 <- plotter(1, start_values, confs, data_f)
f25 <- plotter(25, start_values, confs, data_f)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
f49 <- plotter(49, start_values, confs, data_f)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
f8 <- plotter(8, start_values, confs, data_f)
f32 <- plotter(32, start_values, confs, data_f)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
f56 <- plotter(56, start_values, confs, data_f)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
full_liability <- ggarrange(f1, f25, f49, f8, f32, f56,
                    ncol = 3, nrow = 2)
annotate_figure(full_liability,
                top = text_grob("Full Liability", face = "bold", size = 14))
#Parent 1 full liability burn-in
p1_1 <- plotter(1, start_values, confs, data_p1)
p1_25 <- plotter(25, start_values, confs, data_p1)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p1_49 <- plotter(49, start_values, confs, data_p1)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p1_8 <- plotter(8, start_values, confs, data_p1)
p1_32 <- plotter(32, start_values, confs, data_p1)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p1_56 <- plotter(56, start_values, confs, data_p1)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
parent1_liability <- ggarrange(p1_1, p1_25, p1_49, p1_8, p1_32, p1_56,
                    ncol = 3, nrow = 2)
annotate_figure(parent1_liability,
                top = text_grob("Parent 1 Full Liability", face = "bold", size = 14))
#Parent 2 full liability burn-in
p2_1 <- plotter(1, start_values, confs, data_p2)
p2_25 <- plotter(25, start_values, confs, data_p2)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p2_49 <- plotter(49, start_values, confs, data_p2)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p2_8 <- plotter(8, start_values, confs, data_p2)
p2_32 <- plotter(32, start_values, confs, data_p2)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
p2_56 <- plotter(56, start_values, confs, data_p2)+
                                 theme(axis.text.y = element_blank(),
                                       axis.ticks.y = element_blank(),
                                       axis.title.y = element_blank())
parent2_liability <- ggarrange(p2_1, p2_25, p2_49, p2_8, p2_32, p2_56,
                    ncol = 3, nrow = 2)
annotate_figure(parent2_liability,
                top = text_grob("Parent 2 Full Liability", face = "bold", size = 14))
```

The plots show that all liabilities are independent of their starting value after just a couple of samples, and that it doesn't matter which starting value is chosen. Furthermore, the plots show that the liabilities are quickly independent of their starting value both when the configuration is "111", meaning nobody has the phenotype and "222", meaning everybody has the phenotype. Therefore, we can conclude that there is no difference in the burn-in iterations for different starting values and the burn-in is done after just a couple of iterations. 

To make sure that there all liabilities are independent of their starting value for any given configuration. We will set the number of iterations for the burn-in to be 200, which should be enough iterations to make sure any configurations has valid liabilities to sample from. 